<% content_for :page_title do -%><%= @app.name%><% end -%>
<% content_for :content_header do -%>
<div class="page-header">
  <div class="pull-right">
    <%= link_to("Edit &rarr;".html_safe, edit_app_path(@app), :class => "btn large primary") if user_signed_in? and (@app.user.id == current_user.id) -%>
  </div>

  <h1><%= @app.name%>
    <small><%= @platforms.map(&:name).join(' &bull; ').html_safe%></small>
    <!-- <span class="label warning">unverified</span> -->
  </h1>
</div> 

<% end -%>

<% content_for :include_js do %>
<script type="text/javascript">
$(document).ready(function() {
	Signalike.Source.top({
		dimension: <%= @app.id %>,
		success: function (sources) {
			var source   = $("#_post").html();
			var template = Handlebars.compile(source);
			//sources.items is the list of sources
			//sources.total is the number of sources in the list
			var compiled = [];
			var limit = 20;
			var i;
			limit = Math.min(limit,sources.items.length);
			for(var x = 0; x < limit; x++) {
				i = sources.items[x];
				compiled.push(template(i) );
			}
			
			$('#top_sources').html(compiled.join(''));
			
			console.log(sources);
			console.log($("#pagination"))
			$("#pagination").html('<ul><li class="prev disabled"><a href="#">&larr; Previous</a></li><li class="active"><a href="#">1</a></li><li><a href="#">2</a></li><li><a href="#">3</a></li><li class="next"><a href="#">Next &rarr;</a></li></ul>');
			//get the handlebar template
			source   = $("#_post").html();
			template = Handlebars.compile(source);
			//sources.items is the list of sources
			//sources.total is the number of sources in the list
			compiled = [];
			$.each(sources.items, function (idx, i) {
				compiled.push(template(i));
				// (new Signalike.Source(i.id)).fetch({
				// 	success: function (d) {
				// 		console.log(d);
				// 		
				// 	}
				// });
			});
			
			$('#latest_sources_list').html(compiled.join(''));
		}
	});
	
	var f = $('#newsource');
	
	f.submit(function () {
		var url = f.attr('action');
		var data = f.serialize();
		console.log(url);
		console.log(data);
		$.ajax({
		    type: 'POST',
			url: url,
			data: data,
			success: function (object) {{
				console.log(object)
				if (object.success) {
					window.location.reload();
				}
				else {
					$('#errors').html(object.errors.join("<br />"));
					$('#errors-container').attr("style", "visibility: visible");
				}
			}},
			dataType: 'json'
		})
		return false;
	});
	
	$('#newsource-save').click(function () {
		f.submit();
	});
	
});
</script>
<% end -%>
<script id="_post" type="text/x-handlebars-template">
  <div class="add-bottom">
  <div class="pull-left"><img src="http://placehold.it/36x36" alt=""></div>
  <div class="post-summary">
    <h4><a href="/apps/<%= @app.id%>/posts/{{id}}">{{title}}</a> <small>+{{up}} -{{down}}</small> <span class="label"><a href="{{url}}">link</a></span></h4>
    {{created_at}} &bull; 
    <span class="nowrap"><%= image_tag("http://placehold.it/10x10", :class=>"inline") -%> {{user_id}}</span> 
    &bull; {{domain}} 
    &bull; {{comments}} responses
  </div>
</div>
</script>



<div class="span7 pull-left">
  <h2>About</h2>
  <p><em>Updated <%= time_ago_in_words(@app.updated_at) %> ago by <%= link_to @app.updater, user_path(@app.updater) -%></em></p>
  <ul class="media-grid">
    <% @app.images.each do |image| -%>
    <li>
      <a href="#">
        <img class="thumbnail" src="<%= image.file.thumb.url -%>" alt="<%= image.description -%>" width=105 height=105>
      </a>
    </li>
    <% end -%>
  </ul>
  <p><%= markdown(@app.about) -%></p>

  <h3>Links</h3>
  <address>
	<% if @app.website.presence -%>
    <strong>Web Site</strong><br>
	  <a href="http://<%= @app.website -%>">http://<%= @app.website %></a><br>
  <% end -%>
	<% if @app.twitter.presence -%>
    <strong>Twitter</strong><br>
    <a href="http://twitter.com/<%= @app.twitter -%>">@<%= @app.twitter%></a><br>
  <% end -%>
  <% if @app.facebook.presence -%>
    <strong>Facebook</strong><br>
    <a href="http://facebook.com/<%= @app.facebook -%>">http://facebook.com/<%= @app.facebook -%></a><br>
  <% end -%>
  <% if @app.google_plus.presence -%>
    <strong>Google+</strong><br>
    <a href="http://plus.google.com/<%= @app.google_plus -%>">http://plus.google.com/<%= @app.facebook -%></a><br>
  <% end -%>
  <% if @app.itunes.presence -%>
    <strong>iTunes App Store</strong><br>
    <a href="http://itunes.apple.com/<%= @app.itunes -%>">http://itunes.apple.com/<%= @app.itunes -%></a>
  <% end -%>
  <% if @app.android.presence -%>
    <strong>Android Market</strong><br>
    <a href="https://market.android.com/<%= @app.android -%>">https://market.android.com/<%= @app.android -%></a>
  <% end -%>
  </address>
</div>

<div class="span8 pull-right">
  <div class="pull-right">
    <a href="#" data-controls-modal="modal-add-post" data-backdrop="static" class="btn small primary">Add Post</a>
  </div>
  
  <h2>Posts <small>page 1 of 3 &bull; 30 posts</small></h2>
  <ul class="pills">
    <li class="active"><a href="#">Popular</a></li>
    <li><a href="#">Recent</a></li>
    <li><a href="#">Files</a></li>
    <li><a href="#">Links</a></li>
    <li><a href="#">Questions</a></li>
  </ul>  
  <div id="top_sources">
	Loading...
  </div>

  <div id="pagination" class="pagination">
   
  </div>   
</div>

<div id="modal-add-post" class="modal hide fade" style="display: none; ">
  <div class="modal-header">
    <a href="#" class="close">Ã—</a>
    <h3>Add Post</h3>
  </div>
  <div class="modal-body">
	<%= form_tag app_posts_path(@app.id, :format => :json), :method => :post, :id =>"newsource" do %>
      <fieldset>
		<div id="errors-container" class="clearfix" style="visibility: hidden;">
          	<div id="errors" class="input">
	         </div>          
        </div>
        <div class="clearfix">
          <label for="xlInput">Title *</label>
          <div class="input">
			<%= text_field_tag "source[title]", nil, :id => "xlInput", :size => "30", :class => "span5", :placeholder => ""%>
          </div>
        </div><!-- /clearfix -->
        <div class="clearfix">
          <label for="prependedInput">Link</label>
          <div class="input">
			<%= text_field_tag "source[url]", nil, :id => "prependedInput", :size => "16", :class => "span5",:placeholder =>""%>
          </div>
        </div>        
        <div class="clearfix">
          <label for="fileInput">Files</label>
          <div class="input">
            <input class="input-file" id="fileInput" name="fileInput" type="file">
          </div>
        </div><!-- /clearfix -->        
        <div class="clearfix">
          <label for="textarea">Text</label>
          <div class="input">
			<%= text_area_tag "source[text]", nil, :id => "textarea2", :rows => "5", :class => "span6"%>
          </div>
        </div><!-- /clearfix -->        
      </fieldset>
    <% end -%>
  </div>
  <div class="modal-footer">
    <a href="#" id="newsource-save" class="btn primary">Save</a>
	
    <a href="#" class="btn secondary">Preview</a>
  </div>
</div>

